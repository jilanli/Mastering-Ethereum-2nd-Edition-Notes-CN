# 第 1 章：以太坊是什么？ (What Is Ethereum?)

以太坊（Ethereum）常被称为“世界计算机”。但这究竟意味着什么？我们将从计算机科学的角度出发，通过分析以太坊的功能与特性，并将其与比特币及其他去中心化信息交换平台（确切地说，是区块链）进行对比，来揭开它的面纱。

### 1.1 定义以太坊

* **从计算机科学视角看**：以太坊是一个**确定的（Deterministic）但实际上无界的状态机**。它由一个全球可访问的**单例状态（Singleton State）**和一个用于对该状态应用更改的**虚拟机（Virtual Machine）**组成。
* **从实用角度看**：以太坊是一个开源的、全球去中心化的计算基础设施，用于执行名为**智能合约（Smart Contracts）**的程序。它利用区块链来同步和存储系统的状态变更，并使用名为**以太币（Ether）**的加密货币来计量和限制执行资源的成本[^1]。

以太坊平台使开发者能够构建具有内置经济功能的强大去中心化应用（DApps）。它在提供高可用性、可审计性、透明性和中立性的同时，减少或消除了审查风险，并降低了特定的对手方风险。

---

### 1.2 以太坊与比特币的对比

许多人在接触以太坊之前都有过其他加密货币（特别是比特币）的使用经验。以太坊与比特币有许多共同点：连接参与者的点对点（P2P）网络、用于同步状态更新的拜占庭容错共识算法、密码学原语（如数字签名和哈希）以及数字货币（以太币）。

然而，在许多方面，以太坊的目的和架构与之前的开源区块链截然不同：

1.  **目的不同**：以太坊的主要目的并非作为一个数字货币支付网络。虽然以太币是其运行不可或缺的一部分，但它被定位为一种**功能性货币（Utility Currency）**，用于支付使用以太坊这台“世界计算机”的费用。
2.  **通用性（图灵完备）**：比特币的脚本语言受限，仅能进行简单的逻辑判断。而以太坊旨在成为通用的、可编程的区块链，其运行的虚拟机能够执行任意复杂度的代码。以太坊是**图灵完备（Turing Complete）**的，这意味着它可以作为一台通用计算机运行。
3.  **共识模型**：2022 年 9 月，以太坊通过 **"合并" (The Merge)** 升级，将其共识模型从工作量证明（PoW）转变为**权益证明（PoS）**。这一转变不仅大幅降低了环境影响，还增强了系统的可扩展性和安全性。

---

### 1.3 区块链的组成部分

一个典型的开源公共区块链通常由以下组件构成：

* **P2P 网络**：基于标准的“传播（Gossip）”协议连接参与者，传播交易和经过验证的区块。
* **消息（交易）**：代表状态转换的交易信息。
* **共识规则**：规定了什么是合法交易以及什么是有效的状态转换。
* **状态机**：根据共识规则处理交易的组件。
* **区块链（账本）**：由密码学保护的区块链条，记录所有已验证并接受的状态转换轨迹。
* **共识算法**：通过强制参与者遵守规则，实现对区块链的去中心化控制。
* **激励方案**：基于博弈论设计的方案（如 PoW 成本加区块奖励，或 PoS 质押奖励），在开放环境中保护状态机的经济安全。
* **开源代码实现（客户端）**：上述组件的软件实现。

#### 客户端的演变
在比特币中，参考实现是由 Bitcoin Core 项目开发的单一客户端。以太坊最初也使用单一客户端，但转向 PoS 后，以太坊现在使用两种互补的客户端：**共识客户端（Consensus Client）**和**执行客户端（Execution Client）**。

以太坊不依赖单一的“参考代码实现”，而是依赖**参考规范（Reference Specification）**——即最初在“黄皮书”中记录的数学描述。目前，社区正转向使用 Python 编写的参考规范。

#### 图 1-1：区块链组件示意图
以下是这些组件如何协同工作的逻辑结构：

![Figure 1-1](./images/figure1-1.png)

在过去，我们习惯用“区块链”这个词作为缩写，来代指包含了上述所有特性的技术组合。然而在今天，区块链的种类繁多且属性各异。我们需要通过一些修饰词来准确理解特定区块链的特征，例如：**开放、公共、全球化、去中心化、中立**以及**抗审查**。只有具备了这些修饰词，才能识别出由上述组件构建而成的“区块链”系统所具备的重要涌现特性。

区块链并非千篇一律。尽管它们表现出的属性极其多样，但我们大致可以将区块链归为**许可链 vs 无许可链**，以及**公有链 vs 私有链**两大维度：

#### 无许可链 (Permissionless)
无许可区块链（如比特币和以太坊）对所有人开放。这种去中心化网络允许任何人加入、参与共识过程以及读写数据，通过透明度来建立信任。

#### 许可链 (Permissioned)
许可区块链对访问权限进行了限制，仅允许经过授权的参与者加入网络并执行特定操作。

#### 公有链 (Public)
公有区块链是去中心化的，并向所有人开放。它允许广泛的参与者加入网络活动，并通过大规模的分布式存储和共识机制来确保透明度。

#### 私有链 (Private)
私有区块链将访问权限限制在特定的参与者群体中，通常存在于组织内部或受信任的合作伙伴之间。

---
### 1.4 以太坊的诞生 (The Birth of Ethereum)

所有的伟大创新都是为了解决现实问题，以太坊也不例外。以太坊构思于人们意识到比特币模型的强大，并试图超越货币应用场景的时期。

当时开发者面临着两难境地：要么在比特币之上构建（受限于比特币极其有限的指令集、数据类型和存储容量），要么重新启动一条全新的区块链（这意味着巨大的基础设施开发工作量）。

#### 关键里程碑：
* **2013 年末**：年轻的程序员 **Vitalik Buterin** 开始构思扩展比特币的功能。他最初向 Mastercoin 团队提议了一种通用的、可脚本化（但非图灵完备）的方案，但因过于激进而未被采纳。
* **2013 年 12 月**：Vitalik 发布了以太坊白皮书草案，提出了**图灵完备、通用区块链**的概念。
* **两位共同作者的交集**：
    * **Andreas M. Antonopoulos**：由于当时正忙于编写《精通比特币》，虽对该想法极感兴趣并与 Vitalik 深入讨论，但并未在早期直接参与。
    * **Dr. Gavin Wood**：他是首批联系 Vitalik 的人之一，凭借卓越的 C++ 编程能力成为了以太坊的**联合创始人、联合设计师及 CTO**。

> [!TIP]
> **从“可编程货币”到“通用计算平台”**：
> Gavin Wood 将以太坊的愿景从单纯的数字资产管理提升到了通用计算平台的高度，并提出了 **"Web3"** 的概念——将以太坊视为去中心化技术套件（包括以太坊、Whisper 消息协议和 Swarm 存储协议）中的核心一环。

2015 年 7 月 30 日，以太坊创世区块被成功挖掘。这台“世界计算机”正式开始为世界服务。

---

### 1.5 以太坊的发展阶段 (Stages of Development)

以太坊的开发被划分为四个主要阶段，每个阶段都通过**硬分叉（Hard Forks）**引入重大功能。目前的开发已进入最后的“宁静”阶段。

#### 第一阶段：前沿 (Frontier) - 2015 年 7 月 30 日
* **定位**：创世阶段，为矿工和开发者铺平道路。
* **关键点**：开启 ETH 交易，引入**难度炸弹（Difficulty Bomb）**。
    * *注：难度炸弹旨在通过指数级增加挖矿难度，促使网络最终从 PoW 转向 PoS。*

#### 第二阶段：家园 (Homestead) - 2016 年 3 月 14 日
* **定位**：使网络更安全、更稳定。
* **关键点**：引入了 EIP-2、EIP-7 和 EIP-8 等关键协议更新，虽然仍处于测试阶段，但开发者友好度大幅提升。

#### 第三阶段：大都会 (Metropolis) - 2017 年 10 月 16 日
* **定位**：提升功能性，推动 DApp 的创建。
* **重要分叉**：
    * **拜占庭 (Byzantium)**：优化 Gas 成本，减少挖矿奖励。
    * **君士坦丁堡 (Constantinople)**：优化底层逻辑。
    * **伊斯坦布尔 (Istanbul)**：增强抗 DDoS 能力，引入 **零知识证明 (zk-SNARKs/STARKs)**，为扩展性和隐私奠定基础。

#### 第四阶段：宁静 (Serenity) - 2022 年 9 月 15 日
这是以太坊历史上最重大的升级，即 **以太坊 2.0**。其核心目标是将网络从 PoW 彻底转型为 **权益证明（PoS）**，使其更可持续、高效。

与之前阶段不同，Serenity 后的六个子阶段正在**并行开发**中：

| 子阶段名称 | 核心目标 (Core Goal) |
| :--- | :--- |
| **合并 (The Merge)** | 官方从 PoW 转向 PoS，能耗降低 99% 以上。 |
| **激增 (The Surge)** | 引入**分片 (Sharding)** 技术，大幅提升每秒交易数（TPS）。 |
| **祸根 (The Scourge)** | 解决中心化和抗审查问题，确保网络开放性。 |
| **边缘 (The Verge)** | 引入 **Verkle 树**，优化节点数据存储，提升效率。 |
| **清洗 (The Purge)** | 减少历史过时数据，减轻节点存储压力。 |
| **挥霍 (The Splurge)** | 一系列细节优化，确保所有重大变更后的平稳运行。 |

---
### 1.6 以太坊：通用的区块链 (A General-Purpose Blockchain)

最初的区块链——即比特币区块链——主要追踪比特币单位及其所有权的状态。你可以将比特币想象成一个**分布式共识状态机**：交易引发全局的状态转换，从而改变货币的所有权。这些状态转换受到共识规则的约束，使得所有参与者在若干区块被开采后，能够最终收敛到系统的一个共同（共识）状态。

以太坊同样是一个分布式状态机。但与比特币仅追踪货币所有权状态不同，以太坊追踪的是一个**通用数据存储（General-Purpose Data Store）**的状态转换。具体来说，这是一个可以保存任何可表达为“键值对（Key-Value Tuple）”的数据存储[^2]。

键值存储可以保存任意值，每个值都由某个键引用。例如：
* **键 (Key)**: "Book Title"
* **值 (Value)**: "Mastering Ethereum"

在某种程度上，这与大多数通用计算机所使用的随机存取存储器（RAM）的数据存储模型具有相同的功能。

#### 核心差异与创新
以太坊拥有可以同时存储**代码**和**数据**的内存，并利用以太坊区块链来追踪这些内存随时间变化的情况。就像一台通用存储程序计算机（Stored-Program Computer）一样，以太坊可以将代码加载到其状态机中并**运行**该代码，然后将产生的状态更改存储在区块链中。

与大多数通用计算机相比，以太坊有两个关键区别：
1. **共识驱动**：以太坊的状态更改受共识规则的约束。
2. **全球分布**：状态是在全球范围内分布式存储的。

以太坊实际上回答了这样一个问题：“如果我们可以追踪任何任意状态，并对状态机进行编程，从而创建出一台在共识机制下运行的全球计算机，那会怎样？”
---

> [!NOTE]
> 想要了解更早期的第一手资料？推荐阅读 Vitalik Buterin 的文章 [《以太坊协议的前世今生》(A Prehistory of the Ethereum Protocol)](https://vitalik.eth.limo/general/2017/09/14/prehistory.html)。

---
### 1.7 以太坊的核心组件 (Ethereum’s Components)

在以太坊中，“区块链组成部分”的具体实现细节如下：

#### **P2P 网络**
以太坊运行在**以太坊主网（Ethereum Main Network）**上。该网络通过 TCP 端口 `30303` 进行寻址，并运行名为 **ÐΞVp2p** 的底层协议。

#### **共识规则**
以太坊最初的共识协议是 **Ethash**（一种在“黄皮书”规范中定义的 PoW 模型）。随后在 2022 年 9 月的“合并（The Merge）”升级期间，共识规则演变为**权益证明（PoS）**模型（详见第 15 章）。

#### **交易 (Transactions)**
以太坊交易是网络消息，其包含的内容主要有：发送者（Sender）、接收者（Recipient）、数值（Value）以及数据载荷（Data Payload）。

#### **状态机 (State Machine)**
以太坊的状态转换由**以太坊虚拟机（EVM）**处理。EVM 是一个基于堆栈的虚拟机，用于执行**字节码（Bytecode）**。被称为**智能合约**的 EVM 程序由高级语言（如 Solidity）编写，并编译成字节码后在 EVM 上运行。

#### **数据结构**
以太坊的状态以数据库形式（通常是 Google 的 **LevelDB**）本地存储在每个节点上。该数据库通过一种名为 **Merkle-Patricia Trie（梅克尔-帕特里夏树）** 的序列化哈希数据结构来记录交易和系统状态。



#### **共识算法**
以太坊从 PoW 转型为 PoS 共识机制，以提高能效和可扩展性。在 PoS 中，验证者通过质押加密货币来获取验证交易、创建新区块和维护网络安全的权利。以太坊的 PoS 是两种不同算法的融合：**Casper FFG**（友好终结性小工具）和 **LMD GHOST**（由最新消息驱动的贪婪最重观测子树）。

#### **经济安全**
以太坊使用名为 **Gasper** 的 PoS 算法为区块链提供经济安全性。我们将在第 15 章详细探讨 Gasper 的工作原理，包括它在终结性（Finality）和验证者协调中的作用。

#### **客户端 (Clients)**
以太坊拥有多个可互操作的执行层和共识层客户端软件实现。目前最主流的包括：
* **执行层客户端**：Go-ethereum (Geth)、Nethermind
* **共识层客户端**：Prysm、Lighthouse
* **Engine API**：在当前的 Serenity 阶段，执行客户端与共识客户端之间是通过 Engine API 进行通信的。这种架构实现了以太坊计算逻辑与共识逻辑的完美解耦。
---

#### 延伸阅读资源

* [以太坊“黄皮书” (Ethereum Yellow Paper)](https://ethereum.github.io/yellowpaper/paper.pdf)
* [共识客户端 Python 规范 (Consensus Client Python Specifications)](https://github.com/ethereum/consensus-specs)
* [执行层客户端 Python 规范 (Execution Client Python Specifications)](https://github.com/ethereum/execution-specs)

---
### 1.8 以太坊与图灵完备性 (Ethereum and Turing Completeness)

一旦你开始阅读有关以太坊的内容，就会遇到“图灵完备（Turing complete）”这个术语。人们常说，与比特币不同，以太坊是图灵完备的。这究竟意味着什么？

#### 图灵机的起源
该术语源自被誉为“计算机科学之父”的英国数学家**艾伦·图灵（Alan Turing）**。1936 年，他创建了一个计算机数学模型，该模型由一个状态机组成，通过在顺序存储器（类似于无限长的纸带）上读写符号来操作它们。

通过这一构想，图灵建立了数学基础，用以回答有关**普遍可计算性（Universal Computability）**的问题（即是否所有问题都是可解的）。他证明了存在某些类别的问题是不可计算的。具体而言，他证明了**停机问题（Halting Problem）**是不可解的——即给定一个任意程序及其输入，无法确定该程序最终是否会停止运行。

#### 什么是图灵完备？
图灵进一步定义，如果一个系统可以用来模拟任何图灵机，则称该系统为**图灵完备**。这样的系统被称为**通用图灵机（Universal Turing Machine, UTM）**。

以太坊在名为 **EVM** 的状态机中执行存储程序，同时在内存中读写数据，这种能力使其成为了一个图灵完备系统，因此也是一个通用图灵机。在有限内存的限制下，以太坊可以计算任何图灵机能够计算的算法。

#### 突破性创新
以太坊的突破性创新在于，将存储程序计算机的**通用计算架构**与**去中心化区块链**相结合。由此，它创造了一个分布式的单例（Singleton）世界计算机。以太坊程序看似在“到处”运行，但却产生了一个由共识规则保护的公共状态[^3]。

---
### 1.9 图灵完备性作为一种“特性” (Turing Completeness as a “Feature”)

当你听到以太坊是图灵完备的，可能会得出这样的结论：对于那些非图灵完备的系统来说，这似乎是一种缺失的“特性”。事实恰恰相反。

实现图灵完备其实非常容易。事实上，目前已知最简单的图灵完备状态机仅包含 4 个状态和 6 个符号，其状态定义仅有 22 条指令。确实，有些系统有时会被发现是“无意中实现图灵完备的”（这里有一些关于此类系统的[有趣参考](https://aphyr.com/posts/342-reversing-the-halting-problem)）。

#### 潜在的危险
然而，图灵完备性是非常危险的，尤其是在像公共区块链这样的开放访问系统中，原因正是前一节提到的**停机问题**。

* **案例参考**：现代打印机是图灵完备的。如果你给它发送一个特殊设计的打印文件，可能会导致打印机进入死锁或冻结状态。
* **区块链的挑战**：以太坊的图灵完备性意味着它可以计算任何复杂程度的程序。但这种灵活性带来了棘手的安全和资源管理问题。
    * 打印机死机了，你可以关掉电源再重启。
    * **公共区块链则无法被关机重启。**

由于以太坊上的程序（智能合约）是由成千上万个节点同时运行的，如果一个程序陷入了死循环，这台“世界计算机”就会面临瘫痪的风险。

> [!NOTE]
> **译者注**：这里提到的“停机问题”是计算理论的核心。在以太坊中，解决这一问题的方法不是靠算法检测，而是靠经济惩罚。
> 比特币的选择：为了安全，故意保持“图灵不完备”（不使用循环指令）。
> 以太坊的选择：为了通用性，接受“图灵完备”，但必须发明一种名为 Gas 的“计费仪表”来强行中断那些运行时间过长的程序。

---

[^1]: 实际上经过优化后也可以使用稳定币做资源消耗的限制
[^2]: 通过这里可以推测出，以太坊的底层是一个KV数据库，应该是来自谷歌的LevelDB。
[^3]: 我自己觉得还有一个突破性的创新在于将计算机技术和社会科学相结合，使用经济学的方法限制图灵完备系统的副作用，死循环，避免了无法承受的计算开销。从POW演进到POS也是这种思路的体现。
