# 第十五章：共识(Consensus)

贯穿本书，我们一直在讨论共识规则 (Consensus Rules) —— 即为了让系统以去中心化且确定性的方式运行，所有人必须共同遵守的规则。
在计算机科学中，“共识”这一术语早于区块链出现，它涉及分布式系统中同步状态的更广泛问题，即让分布式系统中的不同参与者最终都对单一的全局状态达成一致。这被称为达成共识。

当涉及到去中心化记录保存和验证的核心功能时，仅靠“信任”来确保状态更新所衍生信息的正确性可能会出现问题。这种普遍挑战在去中心化网络中尤为突出，因为没有中央实体来裁定什么是“真相”。
缺乏中央决策实体正是区块链平台的主要吸引力之一，因为它带来了抵御审查的能力，且访问信息无需依赖权威机构的许可。然而，这些优势是有代价的：
在没有受信任仲裁者的情况下，任何分歧、欺瞒或差异都需要通过其他手段来调和。共识算法 (Consensus Algorithms) 正是用于平衡安全性和去中心化的机制。

在区块链中，共识是系统的关键属性。简而言之，这关乎资金安全！因此，在区块链语境下，共识是指在保持去中心化的同时，能够达成共同状态的能力。
换句话说，共识旨在产生一个“有规则但无统治者”的系统。没有任何个人、组织或团体处于“掌权”地位；相反，权力和控制权分散在广泛的参与者网络中，通过遵守规则和保持诚实来服务于其自身的利益。

在对抗性环境下，在不集中控制权的前提下，跨分布式网络达成共识的能力是所有开放、公共区块链的核心原则。为了应对这一挑战并保持去中心化这一宝贵属性，社区一直在不断尝试不同的共识模型。
本章将探讨这些共识模型及其对以太坊等智能合约区块链的预期影响。

> [Note]
> 虽然共识算法是区块链运作的重要组成部分，但它们运行在最底层的架构中，远低于智能合约的抽象层。换句话说，共识的大部分细节对智能合约编写者来说是不可见的。
> 你不需要了解它们的工作原理就能使用以太坊，就像你不需要了解路由协议的工作原理就能使用互联网一样。

## 共识原则 (Principles of Consensus)

在区块链技术中，特别是在以太坊中，理解共识原则有助于我们理清网络如何维护其完整性并有效地运行。为了更清晰地了解其运作方式，让我们梳理一下其中的核心概念。

### 安全性 (Safety)

在共识机制的语境下，安全性是指确保网络能准确一致地就区块链的当前状态达成共识。这意味着要避免诸如“双花”（Double-spending）和交易冲突等问题，
保持整个网络的一致性。在一个安全的系统中，每个节点对账本历史都有完全相同的视图，其表现就像一个原子化地逐条执行操作的中心化系统。

### 最终确定性 (Finality)

最终确定性是以太坊共识机制中最重要的安全特性之一。它标志着交易被视为已完成且不可逆转的时间点，确保交易一旦被添加到区块链中，
就无法被更改或移除。这种交易的不可逆性为系统注入了极高的信任度，为用户提供了其交易已被永久记录的确定性。 
从本质上讲，最终确定性将安全性的理念付诸实践，使其从一个抽象概念转变为实际保障。它确保了即使网络的不同部分可能有各自的局部视图，
也存在一个不可撤销的协议点，使得区块链的历史变得固定且不可更改。

### 活跃性 (Liveness)

如果说安全性确保了网络中“坏事永远不会发生”，那么活跃性则保证了“好事终究会发生”。换句话说，无论发生什么情况，以太坊网络都会持续处理交易并添加新块。
从另一个角度看，活跃性也可以理解为可用性。在实际操作中，这意味着每当我们向网络中诚实运行的节点提交一笔有效交易时，我们可以预期该交易将被包含在后续的区块中，
从而为区块链的延伸做出贡献。这种对交易包含和处理的预期，对于赢得用户信任和以太坊平台的整体效能至关重要。

### 区块树与分叉 (Block Trees and Forking)

设计一个在任何情况下都同时具备安全性和活跃性的共识协议是不可能的——你必须在两者之间做出取舍（倾向于其中之一）。
虽然以太坊共识协议在网络状况良好时能同时提供安全性和活跃性，但当情况变得混乱时，它会优先考虑活跃性。
它是通过“分叉”的概念来实现这一点的。

在区块链中，每个区块（除了特殊的创世块）都建立在父块之上并指向父块。因此，我们最终得到了一串区块：即区块链。
然而，在实现“分叉共识协议”的链上，这种线性状态在实践中往往并不成立：在现实环境下，我们最终得到的可能更像是一棵区块树（如图 15-1 所示），
而不是单一的链。共识协议的目标就是让网络上的所有节点最终对同一条线性区块序列达成一致。

![Figure 15-1](<./images/figure 15-1.png>)

图 15-1. 区块树结构

区块树中的各个分支被称为分叉 (Forks)。分叉的产生通常是网络延迟、处理延迟、客户端故障或恶意行为的自然结果。

如果我们去查询遵循不同分叉的节点，它们会就系统状态给出不同的答案。这正是“分叉共识协议”的韧性所在：它们在不利条件下不会完全停止运行，
而是选择分叉。 最终，我们希望网络上所有正确的节点都能对历史达成完全一致的线性视图，从而对系统状态达成共识。

协议的分叉选择规则 (Fork Choice Rule) 的任务就是促成这种一致性：给定一个区块树和某些决策标准，
分叉选择规则旨在从所有可用分支中选出那条最有可能最终成为“标准链（Canonical Chain）”的分支。

分叉协议的代价在于，那些遵循了最终未能成为标准链的分支的节点，必须在事后“倒带”它们对现实的认知，撤销最近处理的所有交易，
以便切换到正确的轨道上。这一过程被称为重组 (Reorg) 或回滚 (Reversion)。由于重组具有破坏性，因此协议的设计目标是尽可能将其降至最低。

现在我们可以理解以太坊共识协议中“最终确定性”的威力了：分叉是实现活跃性的强大手段，但为了让网络具备可用性，这种灵活性必须辅以某些安全性保证。

## 工作量证明共识 (Consensus via Proof of Work)

建议译文
工作量证明共识 (Consensus via Proof of Work)

比特币这一原始区块链的创造者发明了一种基于工作量证明 (Proof of Work, PoW) 的共识算法。可以说，PoW 是支撑比特币最重要的一项发明。
PoW 的俗称是“挖矿”，但这导致了人们对共识主要目的的误解。人们通常认为挖矿的目的是创造新货币，因为现实世界中挖矿的目的是开采贵金属或其他资源。
然而，挖矿（以及所有其他共识模型）的真正目的是在确保区块链安全的同时，保持系统控制权的去中心化，并将其分散给尽可能多的参与者。
新铸造货币的奖励是对那些为系统安全性做出贡献的人的一种激励：它是达成目的的手段。从这个意义上说，奖励是手段，而去中心化安全才是目的。

在 PoW 共识中，还存在相应的“惩罚”，即参与挖矿所需的能源成本。这种巨大的能源消耗并非缺陷，而是刻意的安全与激励设计的关键。
如果参与者不遵守规则并赚取奖励，他们就会损失已经投入在挖矿电费上的资金。因此，PoW 共识是风险与回报的细致平衡，驱动参与者出于自身利益而诚信行事。

以太坊最初也是效仿比特币的 PoW 区块链，它使用了一种 PoW 算法，具有相同的基本激励系统和相同的基本目标：在实现控制权去中心化的同时保障区块链安全。
以太坊的 PoW 算法与比特币略有不同，被称为 *Ethash*。

### Ethash：以太坊的 PoW 算法

在以太坊转向权益证明（PoS）之前，它依赖于一种名为 Ethash 的工作量证明（PoW）算法。它是 Dagger-Hashimoto 算法的演进版本，
结合了 Vitalik Buterin 的 Dagger 算法和 Thaddeus Dryja 的 Hashimoto 算法。Ethash 依赖于一个大型数据集的生成和分析，
该数据集被称为有向无环图（Directed Acyclic Graph，简称 DAG）。DAG 的初始大小约为 1 GB，并持续缓慢地线性增长，
每经过一个周期（Epoch，即 30,000 个区块，约 125 小时）更新一次。

DAG 的目的是使 Ethash 算法高度依赖于对大型且频繁访问的数据结构的维护。这反过来旨在使 Ethash 具备 ASIC 抗性（ASIC Resistance），
即增加制造比高性能显卡（GPU）快出几个数量级的专用集成电路（ASIC）矿机的难度。以太坊的创始人希望避免 PoW 挖矿的中心化，
即防止那些拥有芯片制造工厂和巨额预算的人统治挖矿基础设施，从而破坏共识算法的安全性。

使用消费级 GPU 在以太坊网络上执行 PoW 意味着全球有更多的人可以参与挖矿过程。大量的独立矿工意味着挖矿权更加去中心化，
从而避免了像比特币那样，大部分算力集中在少数大型工业化矿场手中的局面。不过，使用 GPU 挖矿的负面影响是它在 2017 年引发了全球显卡短缺，
导致价格飙升并引发了游戏玩家的强烈抗议。这导致零售商出台了限购措施，限制每位客户只能购买一到两块显卡。

直到 2017 年，ASIC 矿机对比特币网络的威胁在很大程度上是不存在的。为以太坊制造 ASIC 需要设计、制造和分发高度定制化的硬件，
这需要投入大量的时间和资金。此外，以太坊开发者长期以来一直计划转向 PoS 共识算法（现已实现），这很可能在很长一段时间内阻止了 ASIC 供应商将以太坊网络作为目标。

## 权益证明共识 (Consensus via Proof of Stake)

从历史上看，PoW 并非第一个被提出的共识算法。在此之前，许多研究者探索过基于财务或名誉权益的构想。更早期的共识模型多为许可型（Permissioned）：
验证者通过权威机构或身份筛选产生，而非公开竞争。例如，实用拜占庭容错（PBFT） 算法需要一组固定或选定的验证者，这种模型至今仍是许多传统分布式系统的基础。

基于 PoW 共识的主要突破在于它实现了无许可性（Permissionless）：任何拥有计算能力的人都可以参与并获得奖励，无需获得加入批准。
这是去中心化的一次巨大飞跃。从某种意义上说，PoW 的发明是为了提供一种替代封闭模型的无许可方案。

随着比特币的成功，许多区块链采用了 PoW。但共识研究的爆发重新激发了人们对 PoS 的兴趣，并带来了重大进展。从一开始，以太坊的创始人们就希望最终迁移到 PoS。
事实上，以太坊最初的 PoW 链内置了一个障碍，即所谓的难度炸弹（Difficulty Bomb），其目的是随着时间的推移缓慢增加挖矿难度，迫使系统向最终转型迈进。
以太坊版的 PoS 虽然是无许可的，但在概念上与早期的基于权威的系统有一定渊源：
在这里，身份和参与权源于质押资产。但由于任何持有 ETH 的人都可以参与，它保留了中本聪设计中“开放获取”的精神。

通常情况下，PoS 算法的运作流程如下： 区块链记录一组验证者名单。任何持有底层加密货币（以太坊中即为以太币）的人都可以通过发送一种特殊的交易，
将他们的以太币锁定到存款合约中，从而成为验证者。验证者轮流提议并对下一个有效区块进行投票，每位验证者投票的权重取决于其存款（即质押量）的大小。
当验证者正确参与协议时，会获得与其质押量成比例的小额奖励。如果他们犯错（如发布不准确或延迟的见证数据），则会受到小额惩罚，数额通常与奖励相当。

但有一种更严重的后果被称为罚没（Slashing），仅当验证者被证明具有恶意行为时才会发生，例如发布相互冲突的见证或对区块进行双重投票。
因此，PoS 通过奖惩机制强制验证者诚实行事并遵守共识规则。PoS 与 PoW 的主要区别在于：PoS 的惩罚是区块链内在的（如损失质押的以太币），而 PoW 的惩罚是外在的（如损失电费开支）。

自 2015 年以太坊发布以来，就一直有转向 PoS 共识协议的意图。2020 年 12 月 1 日，信标链（Beacon Chain） 的启动迈出了实质性的第一步。
最初，信标链是一个“空转”的区块链，允许人们通过在特定存款合约中存入 32 ETH 成为验证者，它仅处理内部验证者及其余额的共识。此时，以太坊主链仍在使用 Ethash。

2022 年 9 月 15 日，合并（The Merge） 硬分叉发生，拥有自身验证者集的信标链将其 PoS 共识协议扩展到了以太坊主链，正式结束了 Ethash 的使用。
不过，当时仍存在一些局限，例如验证者无法提取资金并退出验证者集。这些问题在 2023 年 4 月 12 日的 Shapella（上海+卡佩拉）升级 中得到彻底解决，
标志着以太坊从 PoW 到 PoS 共识协议转型的全面完成。

以太坊所使用的 PoS 共识协议被称为 Gasper。在接下来的章节中，我们将探索它的运作原理，从基础术语开始，
逐步深入到分叉选择规则（LMD-GHOST）和最终性组件（Casper FFG）。最后，我们将通过一个实例来阐明我们讨论过的理论概念。

## PoS 术语 (PoS Terminology)
在本节中，我们将重点介绍以太坊 PoS 共识的组成部分及其术语。

### 节点与验证者 (Nodes and Validators)
节点构成了以太坊网络的骨干。它们相互通信，负责验证共识的遵守情况。验证者负责提议新区块并对其进行投票，它们附属于这些节点。
但与名称所暗示的相反，验证者本身并不实际验证区块；相反，是节点软件在检查区块和交易是否符合协议规则。一个节点可以托管多个验证者，
验证者的职责是通过运行执行客户端（Execution Client）和共识客户端（Consensus Client）共同完成的。
我们将在接下来的章节中详细了解这些职责。

PoS 有一个需要牢记的独特属性：活跃验证者的集合是已知的。这是实现“最终确定性”的关键，因为我们可以识别何时达到了参与者的多数投票。

### 区块与见证 (Blocks and Attestations)
严格的时间管理是以太坊 PoS 的一个重要属性。PoS 中有两个关键的时间间隔：时隙（Slot），时长恰好为 12 秒；
以及周期（Epoch），跨越 32 个时隙。

在每一个时隙（Slot）中，会有且仅有一名验证者被选中来提议区块。在每一个周期（Epoch）期间，每位验证者都有机会以“见证（Attestation）”的形式分享一次其对世界的视图。

一个见证包含了两类投票：
* 链头投票：用于 LMD-GHOST 协议，决定当前哪条链是主链。
* 检查点（Checkpoint）投票：用于 Casper FFG 协议（即“友好最终性小工具”），旨在锁定历史记录。
由于分享见证数据非常消耗带宽，因此这些投票被分布在整个周期的各个时隙中，而不是集中在每个区块产生时，以此来分散工作负载并确保网络负荷可控。

该协议通过针对验证者的奖惩机制来激励区块和见证的产出及准确性。然而，它也容忍**空时隙**（Empty slots）和缺失的见证，
这种情况的发生可能是由于自然原因（例如节点掉线），也可能是出于利润驱动的考量。我们将在后文的“时机博弈（Timing Games）”一节中详细展开讨论。

## LMD-GHOST

LMD-GHOST 是以太坊共识协议的核心部分：它是分叉选择规则（Fork Choice Rule）算法。它负责从节点的本地视图中，
选出其应当认为有效的最新区块。这个区块也被称为链头（Head of the Chain）。

要完全理解其工作原理，你必须了解以太坊 PoS 协议的一些基础概念。在经典且基于 PoW 的共识协议中，
负责创建新区块并将其添加到链上的实体（即矿工）不需要满足任何特殊要求。只要他们发布了一个满足 PoW 难度的区块，
该区块就会被整个网络接受。但在以太坊基于 PoS 的共识协议中，验证者必须质押大量的 ETH 作为抵押品——目前至少为 32 ETH——才能进入验证者集合。

正如我们之前简要提到的，验证者有两项主要职责：

**区块提议 (Block Proposing)**

在每个时隙（Slot）中，会通过伪随机算法选出一名验证者来创建并提议链上的下一个区块。

**创建见证 (Creating Attestations)**

在每个时隙中，比例约为 $1/32$ 的验证者会被选中，发布他们对“谁是当前最佳链头”的投票。这些选票随后以“见证（Attestation）”的形式分享给每一位验证者。

当验证者在见证中投票给某个特定区块时，实际上是在为该区块分配一个“分数”。这个分数恰好等于该验证者发布见证时所质押的 ETH 数量。
不仅如此：这一票不仅是投给该区块的，也是投给该区块所在分叉路径上的所有祖先区块的，如图 15-2 所示。

![Figure 15-2](<./images/figure 15-2.png>)

图 15-2. 投票向祖先传播

你可以认为，投给某个区块的一票会向后传播到其所有的祖先区块。为了让这个概念更加清晰，我们可以为所有分支（Branches）分配一个分数。
如图 15-3 所示，分支是将区块与其父区块连接起来的链路。

![Figure 15-3](<./images/figure 15-3.png>)

图 15-3. 分支的定义

我们将一个分支的分数定义为：该分支末端区块的分数（如图 15-3 中的区块 B）加上其所有直接后代分支分数之和。

图 15-4 展示了一个每个区块分数为 1 的区块轴。
* 分支 E→D：分数恰好等于区块 E 的分数（1），因为它没有后代区块。
* 分支 D→C：其分数为区块 D 的分数（1）加上所有后代分支的分数（分支 E→D 为 1），即 $1 + 1 = 2$。
* 分支 C→B：其分数为区块 C 的分数（1）加上分支 D→C 的分数（2），即 $1 + 2 = 3$。
* 分叉点：此时出现了一个带有区块 C′ 的小分叉。
* 分支 C′→B：分数仅为 1（区块 C′ 的分数），因为 C′ 没有直接后代。
* 分支 B→A：为了计算其分数，我们需要将区块 B 的分数（1）加上分支 C′→B 的分数（1）以及分支 C→B 的分数（3），总计为 $1 + 1 + 3 = 5$。







































































































































