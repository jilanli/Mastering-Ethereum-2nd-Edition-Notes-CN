# 第十四章：以太坊虚拟机

以太坊虚拟机（EVM）是以太坊协议和运行的核心。正如你从名字中猜到的那样，它是一个计算引擎，与微软 .NET 框架的虚拟机或 Java 等其他字节码编译语言的解释器并没有本质区别。
在本章中，我们将深入探讨 EVM 的指令集、架构及其在以太坊状态更新背景下的运作方式。

## 什么是 EVM
EVM（以太坊虚拟机）是以太坊中负责处理智能合约部署与执行的核心部分。从实际操作层面来看，从一个外部账户（EOA）到另一个外部账户的简单价值转账交易并不需要它参与；
除此之外，几乎所有的操作都会涉及由 EVM 计算的状态更新。从宏观角度来看，运行在以太坊区块链上的 EVM 可以被视为一台全球化的去中心化计算机，
它包含数百万个可执行对象，每个对象都有其独立的永久数据存储库。

EVM 是一个**准图灵完备**（Quasi-Turing-Complete）状态机：之所以说它是“准”完备，是因为所有的执行过程都受限于气数（Gas）的额度，
而 Gas 限制了任何给定智能合约执行的计算步数。因此，**停机问题**（Halting Problem）得到了“解决”（所有程序的执行最终都会停止），
从而避免了执行过程（因意外或恶意）永久运行并导致整个以太坊平台陷入停滞的情况。我们将在本章稍后部分更详细地探讨停机问题。

EVM 采用栈式架构（Stack-Based Architecture），将所有内存中的数值存储在栈（Stack）上。
它的字长（Word Size）为 256 位，这主要是为了便于进行原生的哈希运算和椭圆曲线运算。它拥有以下几个可寻址的数据组件：
* 不可变的程序代码 ROM：加载了待执行智能合约的字节码。
* 易失性内存（Memory）：每个位置在初始状态都被显式地置为零。
* 瞬时存储（Transient Storage）：仅在单笔交易期间存在（且不属于以太坊状态的一部分）。
* 永久存储（Storage）：是以太坊状态的一部分，初始状态同样被置为零。

此外，在执行期间还有一组环境变量和数据可供调用。我们将在本章稍后部分详细介绍这些内容。
![Figure 14-1](<./images/figure 14-1.png>)
图 14-1. EVM 架构与执行上下文

## 与现有技术的比较
“虚拟机”一词通常应用于对真实计算机的虚拟化——通常由 VirtualBox 或 QEMU 等管理程序（Hypervisor）实现；
或者是对整个操作系统实例的虚拟化，如 Linux 的 KVM。这些技术必须分别提供对实际硬件、系统调用以及其他内核功能的软件抽象。

EVM 的运行领域则受限得多：它仅仅是一个计算引擎，因此仅提供对计算和存储的抽象，这一点类似于 Java 虚拟机（JVM）规范。
从宏观角度看，JVM 旨在提供一个与底层主机操作系统或硬件无关的运行环境，从而实现跨多种系统的兼容性。
诸如 Java、Scala（使用 JVM）或 C#（使用 .NET）等高级编程语言，都会被编译成各自虚拟机的字节码指令集。
同样地，EVM 执行其专有的字节码指令集（将在下一节描述），而 Solidity、Vyper 和 Yul 等高级智能合约编程语言也会被编译成这种字节码。

因此，EVM 不具备调度能力，因为执行顺序是在其外部组织的：以太坊客户端通过扫描经过验证的区块交易，
来确定哪些智能合约需要执行以及按何种顺序执行。从这个意义上说，以太坊世界计算机是单线程的，类似于 JavaScript。
EVM 也不具备任何“系统接口”处理或“硬件支持”——因为它没有物理机器可以进行接口交互。以太坊世界计算机是完全虚拟的。

## 其他区块链在做什么？

EVM 绝对是加密货币领域应用最广泛的虚拟机。大多数竞争性 L1（第一层）和 L2（第二层）区块链都采用 EVM，以保持与现有工具和框架的兼容性，
并直接从以太坊社区吸引项目和开发者。

尽管如此，近年来也涌现出了一批各具特色的虚拟机：Solana VM、Wasm VM、Cairo VM 和 Move VM 可能是其中最著名且最有趣的，
它们各有利弊。这些虚拟机在智能合约开发路线上采取了不同的方案：

**自定义语言**

一些平台（如 Cairo 和 Move）创建了专门用于编写智能合约的编程语言。这类似于以太坊为其虚拟机 EVM 使用 Solidity 和 Vyper。

**标准语言**

其他平台（如 Solana 和使用 WebAssembly (Wasm) 的平台）允许开发者使用广泛通用的编程语言编写智能合约。
例如，这些平台通常支持使用 Rust 进行开发。

这些替代虚拟机与 EVM 的另一个不同之处在于交易的并行化（Parallelization）。我们已经提到过，EVM 按顺序处理交易，没有任何形式的并行化。
一些项目针对这一缺陷进行了改进。例如，Solana VM 和 Move VM 都能处理交易的并行执行，尽管这并非在所有情况下都可行——也就是说，
当两笔交易通过与同一个合约交互来修改同一块存储空间时，它们无法并行执行。

必须说明的是，这些改进虚拟机性能的努力并不仅仅发生在以太坊之外。事实上，许多团队正致力于突破 EVM 的当前限制，
尝试引入并行化以及其他酷炫功能，例如将 EVM 字节码**提前编译（AOT）或即时编译（JIT）**为原生机器码。

## The EVM Instruction Set (Bytecode Operations)







