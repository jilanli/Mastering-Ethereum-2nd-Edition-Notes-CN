# 第十一章：预言机（Oracles）

在本章中，我们将讨论预言机（Oracles）。预言机是能够为以太坊智能合约提供外部数据源的系统。
“预言机”一词源于希腊神话，指能够与神灵沟通并预见未来的神谕者[^1]。在区块链的语境下，预言机是一个能够回答以太坊外部问题的系统。
理想情况下，预言机应该是**去信任化**（Trustless）的系统，这意味着它们不需要被信任，因为它们是基于去中心化原则运行的。

## 为什么需要预言机

以太坊平台的一个核心组件是 EVM（以太坊虚拟机），它能够在去中心化网络中的任何节点上，受共识规则约束，执行程序并更新以太坊状态。
为了维持共识，EVM 的执行必须是完全确定性的，且仅基于以太坊状态和签名交易的共享上下文。
这导致了两个尤为重要的后果：第一，EVM 和智能合约无法拥有内在的随机数来源；第二，外部数据只能作为交易的数据载荷（Payload）被引入。

让我们进一步拆解这两个后果。为了理解 EVM 为何禁止提供真随机函数，请考虑在执行此类函数后尝试达成共识的效果：节点 A 执行命令后，代表智能合约在其存储中存入了数字 3；
而节点 B 在执行同一个智能合约时，却存入了 7。这样，尽管节点 A 和 B 在相同的语境下运行了完全相同的代码，却会对最终应有的状态得出不同的结论。
事实上，每次对该智能合约进行评估时，都可能得到不同的结果状态。因此，遍布全球、独立运行的众多节点将无法就结果状态达成去中心化共识。
在实践中，情况会比这个例子恶化得更快，因为包括以太币转账在内的连锁反应会呈指数级累积。

需要注意的是，伪随机函数（例如加密安全哈希函数，它们是确定性的，因此可以——实际上也确实是——EVM 的一部分）对于许多应用来说是不够的。
以一个模拟抛硬币来结算赌注的博弈游戏为例，它需要随机化正反面：区块提议者（Proposer）可以通过参与游戏并仅将能让他们获胜的交易包含在区块中来获取优势。
那么，我们该如何绕过这个问题呢？由于所有节点都能对签名交易的内容达成一致，因此包括随机源、价格信息、天气预报等在内的外部信息可以作为发送至网络的交易数据部分被引入。
然而，此类数据是不可信的，因为它们来自不可验证的源头。因此，我们只是推迟了问题的发生。我们使用预言机来尝试解决这些问题，本章余下部分将对此进行详细讨论。

## 预言机的使用案例与示例

理想情况下，预言机提供了一种去信任化（或至少接近去信任化）的方式，将外部（即“现实世界”或链下）信息——如足球比赛结果、黄金价格或真随机数——引入以太坊平台供智能合约使用。
它们也可以用于将数据安全地直接转发给 DApp 前端。因此，预言机可以被视为连接链下世界与智能合约之间的桥梁。目前，它们大多被用于在不同区块链之间传递信息，例如代币价格。

允许智能合约基于现实世界的事件和数据来执行合同关系，极大地扩展了它们的应用范围。然而，这也会给以太坊的安全模型带来外部风险。
以一个在人去世时分配资产的“智能遗嘱”合约为例。这是智能合约领域经常讨论的话题，同时也凸显了受信任预言机的风险。
如果该合约控制的遗产金额足够高，那么黑客攻击（这也可能意味着收买中心化预言机的人级操作员）预言机并在所有者去世前触发资产分配的动机就会非常强烈。

需要注意的是，某些预言机提供的数据特定于某些私有数据源，例如学历证书或政府身份 ID。此类数据的来源（如大学或政府部门）是完全受信任的，且数据的真实性是主观的（真实性仅取决于对来源权威机构的诉求）。
因此，由于没有独立可验证的客观事实，此类数据无法通过“去信任化”的方式提供（即不能不信任来源）。即便如此，我们将这些数据源也纳入“预言机”的定义中，因为它们同样为智能合约提供了数据桥梁。
它们提供的数据通常以证明（Attestations）的形式存在，如护照或成就记录。证明将成为未来区块链平台成功的重要组成部分，特别是在验证身份或声誉的相关问题上，因此探索区块链平台如何服务于这些证明至关重要。

以下是预言机可能提供的数据的一些更多示例：
* 来自物理源（如量子或热力学过程）的随机数或熵（例如，为了在彩票智能合约中公平地选出中奖者）
* 指数挂钩自然灾害的参数化触发器（例如，触发巨灾债券智能合约，如地震债券的里氏震级测量）
* 汇率数据（例如，为了让加密货币准确锚定法币）
* 资本市场数据（例如，为代币化资产或证券篮子定价）
* 基准参考数据（例如，将利率纳入智能金融衍生品中）
* 静态或准静态数据（例如，证券识别码、国家代码、货币代码等）
* 基于精确时间测量的事件触发器的时间与间隔数据
* 天气数据（例如，基于天气预报的保险费计算）
* 用于预测市场结算的政治事件
* 用于预测市场结算和幻想体育合约的体育赛事
* 地理位置数据（例如，用于供应链追踪）
* 保险合约的损失验证
* 发生在其他区块链上的跨链事件（用于互操作功能）
* 以太币市场价格（例如，用于计算法币计价的 Gas 价格预言机）
* 飞行统计数据（例如，用于团体和俱乐部进行的机票池化）

在接下来的章节中，我们将研究预言机的一些实现方式，包括基础预言机模式、计算预言机、去中心化预言机以及 Solidity 中的预言机客户端实现。

## 预言机设计模式

根据定义，所有预言机都提供几个关键功能。这些功能包括：

* 从链下数据源收集数据
* 通过签名消息将数据传输到链上
* 使数据可供调用

一旦数据在智能合约中可用，其他智能合约就可以通过消息调用（Invoke）该预言机合约的 retrieve 函数来访问这些数据；
以太坊节点或支持网络连接的客户端也可以直接访问这些数据。

设置预言机的三种主要方式可以归纳为：即时读取（Immediate-read）、发布-订阅（Publish-subscribe）和请求-响应（Request-response）。

### 即时读取（Immediate-Read）

让我们从最简单的预言机类型开始。即时读取预言机提供的是仅用于即时决策的数据，例如：“ethereumbook.info 的地址是什么？”或“此人是否已满 18 岁？”。

![Figure 11-1](<./images/figure 11-1.png>)

图 11-1 即时读取预言机交互示意图

这类数据的查询者倾向于在“准时（Just-in-time）”的基础上进行查询；即在需要信息时进行查找，之后可能不再查询。
此类预言机的例子包括持有组织机构相关数据或由这些组织发布的数据，如学历证书、拨号代码、机构会员资格、机场标识符、自主身份 ID（Self-sovereign IDs）等。

这种类型的预言机将数据存储在其合约存储空间中一次，任何其他智能合约都可以通过向该预言机合约发送请求调用（Request call）来查阅。
数据可以被更新。预言机存储中的数据也可以由支持区块链（即连接到以太坊客户端）的应用直接查询，而无需经历繁琐的过程或承担发送事务所产生的 Gas 成本。
一家需要核实购买酒类客户年龄的商店就可以通过这种方式使用预言机。对于那些原本必须运行和维护服务器来响应此类数据请求的组织或公司来说，这种类型的预言机非常有吸引力。

请注意，预言机存储的数据很可能不是它所提供的原始数据——例如出于效率或隐私的考虑。一所大学可能会为往届学生的学业成就证书设立一个预言机。
然而，存储证书的所有详细细节（可能涉及数页的修读课程和取得的成绩）将是过度浪费的。相反，证书的哈希值（Hash）就足够了。同样地，政府可能希望将公民身份 ID 放入以太坊平台，而这些细节显然需要保密。
同样，对数据进行哈希处理（更严谨的做法是使用带有盐值 (Salts) 的默克尔树 (Merkle trees)），并仅在智能合约的存储中存储根哈希（Root hash），将是组织此类服务的一种高效方式。

### 发布-订阅（Publish-Subscribe）

下一种设置是“发布-订阅”模式。在这种模式下，预言机实际上为那些预期会发生变化的数据（可能是定期且频繁地变化）提供广播服务。
正如图 11-2 所示，这种预言机既可以由链上的智能合约进行轮询（Poll），也可以由链下的守护进程（Daemon）监控其更新。

![Figure 11-2](<./images/figure 11-2.png>)

图 11-2. 发布-订阅预言机

> [!Note]
> 我们也可以移除链下的守护进程。预言机可以保存更新的时间戳，并在读取数据时将其传递给智能合约。
> 通过这种方式，智能合约能够获知数据的最后更新时间，并自主选择是否使用该数据。

这一类别具有类似于 RSS 订阅、WebSub 等模式的特点：当预言机更新了新信息时，会有一个标志位（Flag）向那些“订阅者”发出信号，提示新数据可用。
感兴趣的相关方必须要么轮询预言机以检查最新信息是否已更改，要么监听预言机合约的更新事件，并在更新发生时采取行动。
此类例子包括价格喂价（Price feeds）、天气信息、经济或社会统计数据、交通数据等。

在 Web 服务器的世界里，轮询是非常低效的，但在区块链平台的 P2P 上下文中则不然。以太坊客户端必须同步所有的状态变化，包括合约存储的变化，因此，轮询数据变化只是对已同步客户端的一次本地调用。
以太坊的**事件日志**（Event logs）使得应用监控预言机更新变得异常简单，因此从某些方面来看，这种模式甚至可以被视为一种“推送（Push）”服务。

### 请求-响应（Request-Response）

请求-响应类别是最复杂的：在这种场景下，由于数据空间过于庞大，无法全部存储在智能合约中，且用户通常每次只需要整个数据集的一小部分，正如图 11-3 所示。这也是数据提供商业务所采用的一种适用模型。

![Figure 11-3](<./images/figure 11-3.png>)

图 11-3. 请求-响应预言机

在实践中，此类预言机可能被实现为一个由链上智能合约和链下基础设施组成的系统，用于监控请求并检索、返回数据。来自去中心化应用的数据请求通常是一个包含多个步骤的异步过程。
在这种模式中，首先由一个外部账户（EOA）与去中心化应用进行交易，从而触发与预言机智能合约中定义的函数交互。该函数发起对预言机的请求，相关参数详细说明了请求的数据，
此外还可能包含补充信息，如回调函数和调度参数。

一旦该交易被验证，预言机请求就可以通过预言机合约发出的 EVM 事件或状态更改被观察到；参数可以被检索并用于执行对链下数据源的实际查询。
预言机还可能要求为处理请求支付费用、为回调支付 Gas 费，以及访问所请求数据的权限。最后，结果数据由预言机所有者签名，以证明该数据在给定时间的有效性，
并通过一笔交易交付给发起请求的去中心化应用——可以直接交付，也可以通过预言机合约中转，正如图 11-3 所示。根据调度参数的不同，预言机可能会定期发布进一步的交易来更新数据（例如，每日收盘价格信息）。

请求-响应预言机的步骤可总结如下：

1. 接收来自 DApp 的查询。
2. 解析该查询。
3. 检查支付金额和数据访问权限是否已提供。
4. 从链下数据源检索相关数据（如有必要则进行加密）。
5. 签署包含该数据的交易。
6. 将交易广播至网络。
7. 调度任何进一步必要的交易，如通知等。

还可能存在其他方案；例如，数据可以由一个外部账户（EOA）直接请求并返回，从而省去预言机智能合约。同样，请求和响应也可以由具备物联网（IoT）功能的硬件传感器发起和返回。因此，预言机可以是人、软件或硬件。

此处描述的请求-响应模式在客户端-服务器架构中很常见。虽然这是一种允许应用进行双向对话的有用消息模式，但在某些情况下可能并不合适。
例如，一个需要预言机提供利率的智能债券，在请求-响应模式下（由于这种异步性，发起请求的 DApp/合约需要设计成能够处理延迟响应，而不能期望在同一笔交易中立即获得数据）可能必须每天请求数据，以确保利率始终正确。
考虑到利率变化并不频繁，发布-订阅模式在这里可能更合适——尤其是考虑到以太坊有限的带宽。

发布-订阅是一种模式，其中发布者（在此语境下指预言机）不直接向接收者发送消息，而是将发布的消息分类。
订阅者能够对一个或多个类别表示兴趣，并仅检索感兴趣的消息。在这种模式下，预言机可以在每次利率变化时将其写入自己的内部存储。
多个订阅了该服务的 DApp 只需从预言机合约中读取即可，从而在降低存储成本的同时减少对网络带宽的影响。

在**广播**（Broadcast）或**组播**（Multicast）模式中，预言机将所有消息发布到一个频道，订阅合约通过各种订阅模式监听该频道。
例如，预言机可能向加密货币汇率频道发布消息。如果一个订阅合约需要时间序列数据来进行移动平均线计算，它可以请求频道的全部内容；
而另一个合约可能只需要最新汇率来进行现货价格计算。在预言机不需要知道订阅合约身份的情况下，广播模式是非常合适的。

## 数据认证

如果我们假设 DApp 查询的数据源既权威又可信（这是一个相当重大的假设），那么仍然存在一个突出的问题：
鉴于预言机和“请求-响应”机制可能由不同的实体运营，我们如何能够信任这一机制？数据在传输过程中极有可能被篡改，
因此，链下方法必须能够对返回数据的完整性进行证明（Attest），这一点至关重要。数据认证的两种常见方法是真实性证明（Authenticity proofs）和可信执行环境（TEEs）。

真实性证明依赖于加密保证，确保数据在从源头到区块链的传输过程中未被更改。这些证明将信任目标从传输机制转移到了可验证的证明者身上，
例如数据提供商、安全的第三方、甚至是去中心化的节点网络。通过在链上验证加密签名或零知识证明，智能合约可以确认其收到的信息确实来自正确的权威机构且未被篡改，
而且通常不需要原始数据源实现特殊的签名逻辑。

> [!Note]
> 一个实际的例子是 Chainlink VRF（可验证随机函数）。从 Chainlink 的文档中我们可以了解到：“对于每个请求，Chainlink VRF 会生成一个或多个随机值，
> 以及关于这些值是如何确定的加密证明。该证明在任何消费应用（Consuming applications）使用这些值之前，都会在链上发布并经过验证。”
> 因此，Chainlink VRF 能够证明它是如何生成随机值的，这实际上就是一种真实性证明。
>
> Chainlink VRF 的工作原理是：由一个已部署的智能合约向 Chainlink 预言机网络请求随机数，并提供一个预言机无法预测的“提示（Hint）”。
> 每个预言机使用其私钥在链下生成随机数，然后将结果和相应的加密证明发布到链上。智能合约可以使用预言机的公钥和原始提示来验证这个随机输出是否被操纵。
> 由于证明完全在链上进行验证，攻击者无法在不使加密检查失效的情况下篡改结果。一旦某个节点被攻破或无响应，其失败记录会被记录在链上，并最终被排除在提供随机数的服务之外。

可信执行环境（TEEs）通过利用专门的硬件飞地（Hardware Enclaves）来加强这些保证，这些飞地能够保护并证明代码和数据的完整性。
当计算在这样的飞地内部运行时，CPU 会确保外部进程无法干扰它或查看底层数据，从而同时保护了完整性和机密性。
随后，飞地可以提供一份经过数字签名的“证明”（Attestation），确认某段特定的代码（通过加密哈希识别）正在该安全环境内运行。
这使得智能合约能够获得更强的保证，即任何外部数据或计算在进入链上之前都没有被恶意篡改。安全飞地还实现了隐私功能，因为敏感输入可以在飞地内部加密处理，而无需向外界透露。

在许多现代预言机网络中，这些方法可以结合使用以进一步增强数据认证。一些网络依赖于去中心化的独立节点集，这些节点从不同的源头抓取并验证数据，然后就正确结果达成共识。
这种多运营者系统极大地降低了单个恶意行为者破坏数据喂价的风险，因为节点受到激励机制的约束，且通常有经济抵押（Bonded）以保持诚实。另一些网络则结合了先进的加密协议，
以证明数据源自特定的端点而不暴露底层细节，从而减少了对完全中心化验证者的依赖。某些网络运营者还部署硬件飞地来运行其数据抓取逻辑，确保即使主机环境被攻破，提交给区块链的最终结果仍保持不变且可被独立验证。

无论具体的实现方式如何，最大的挑战在于确保检索并传递到 DApp 的任何数据都是精确且可信的。真实性证明提供了一种追踪和验证数据获取来源及方式的稳健方法，
而 TEE 则提供了一种基于硬件的手段，保护收集和转发链下信息的整个过程。

> [!Warning]
> 由于 TEE 是一项相对较新的技术，它们在很大程度上尚未经过充分测试，可能包含许多未发现的漏洞，未来很可能会发现新的漏洞并被攻破。

## 计算预言机

到目前为止，我们仅在请求和交付数据的背景下讨论了预言机。然而，预言机也可用于执行任意计算，考虑到以太坊固有的区块 Gas 上限和相对昂贵的计算成本，这一功能尤为有用。
计算预言机不仅可以转发查询结果，还可以对一组输入执行计算，并返回一个在链上可能无法计算的结果。例如，你可以使用计算预言机执行计算密集型回归计算，以估算债券合约的收益率。

Lagrange 和 Brevis 被称为 ZK 协处理器，它们使智能合约能够执行链下密集型计算，同时仍确保链上验证。以 Brevis 为例，它允许 DApp 请求复杂任务或历史数据，
而无需预先生成零知识证明。相反，网络会“乐观地（Optimistically）”发布结果，即假定结果是正确的。一旦结果在链上发布，就会进入一个挑战期（Challenge window），
任何人都可以对此提出异议。如果结果受到挑战，提议者必须生成一份完整的零知识证明（ZK Proof）来验证结果。如果未能提供证明，或者证明显示初始结果错误，挑战者将获得奖励，
而提交错误结果的人将受到处罚。如果没有挑战出现，结果将被接受为有效。这种机制大幅减少了所需的零知识证明数量并降低了成本。


## 去中心化预言机

虽然中心化的数据或计算预言机足以满足许多应用的需求，但它们代表了以太坊网络中的单点故障（Single points of failure）。
许多方案围绕“去中心化预言机”这一构思被提出，旨在确保数据可用性，并建立一个由个人数据提供商组成、具备链上数据聚合系统的网络。

Chainlink 提出了一种去中心化预言机网络，由三个核心智能合约组成：信誉合约（Reputation contract）、订单匹配合约（Order-matching contract）和聚合合约（Aggregation contract），
以及一个链下的数据提供商注册表。信誉合约用于追踪数据提供商的表现，其分数用于填充链下注册表。
订单匹配合约根据信誉合约选择预言机的投标，随后敲定服务等级协议（SLA），其中包括查询参数和所需的预言机数量。
这意味着购买者无需直接与单个预言机进行交易。聚合合约收集来自多个预言机的响应（通过承诺-揭示 [Commit-reveal] 方案提交），计算查询的最终集体结果，并最终将结果反馈给信誉合约。

这类去中心化方法面临的主要挑战之一是**聚合函数**（Aggregation function）的制定。Chainlink 建议计算加权响应，允许为每个预言机的响应报告一个有效性分数。
在这里，检测无效分数并非易事，因为这基于一个前提：即通过与同行响应的偏差来衡量的离群数据点是错误的。基于响应在全部分布中的位置来计算有效性分数，
存在惩罚“正确答案”而奖赏“平均答案”的风险。因此，Chainlink 提供了一套标准的聚合合约，但也允许指定自定义的聚合合约。

一个相关的构思是 *SchellingCoin 协议*。在该协议中，多名参与者报告数值，并取中位数作为“正确”答案。
报告者被要求提供一笔押金，这笔押金会重新分配给那些更接近中位数的数值报告者，从而激励参与者报告与其他人的值相似的数值。
一个共同的数值，也被称为谢林点（Schelling point），是指参与者可能认为的、用于协作的自然且明显的目标，预计该值会接近实际真实值。

## 跨链消息传递协议

许多应用频繁要求在多个区块链之间进行数据传输和交互，而每个链都有自己的社区治理、共识规则和代币标准。
跨链协议已成为促进区块链间通信的关键工具，允许智能合约和去中心化应用访问更广泛的服务、流动性和数据。
如果说预言机是将外部信息引入单个区块链的桥梁，那么跨链协议则通过连接整个生态系统扩展了这一概念。

理解跨链协议的一种方式是将其视为连接区块链的专门“通信层”。这些协议不仅用于摄取外部数据，还促进了链与链之间的信息传输。

在流行的跨链方案中，LayerZero 提供了一个跨区块链轻量级消息传递的框架。它通过专注于消息的“传输”和“验证”，
旨在提供一个更高效、更灵活的互操作层。LayerZero 的设计围绕两个关键的链下实体展开——预言机（Oracle）和中继器（Relayer）——它们协同工作以验证跨链交易，正如图 11-4 所示。

![Figure 11-4](<./images/figure 11-4.png>)

图 11-4. LayerZero 跨链架构

预言机（Oracle）对交易证明或区块头执行独立查询，而中继器（Relayer）则负责传递证明本身。通过使用一组用户可配置的预言机和中继器，可以实现信任的去中心化。
如果预言机和中继器提供的数据一致，LayerZero 在目标链上的智能合约就会接受该消息为有效。这使得开发者能够创建复杂的互操作性解决方案，而无需依赖单一的桥接提供商或中心化实体。

另一个著名的项目 Wormhole，最初是为了实现 Solana 和以太坊之间的资产转移。此后，它已扩展到包括币安智能链（BSC）、Hyperliquid 和 Avalanche 在内的其他网络。
Wormhole 的方法基于一个**守护者**（Guardians）网络，这些守护者负责监控单个链上的事件，并签署证明这些事件的消息。一旦有足够数量的守护者完成签署，
该证明就被视为有效，从而允许目标链识别相应的事件（如代币转移），正如图 11-5 所示。这种方案不仅有助于代币桥接，还能处理更复杂的任务，如跨链治理提案和 NFT 转移。
Wormhole 旨在通过结合多个守护者的安全性来降低单点故障风险；然而，这需要对守护者集合进行细致的选择和维护。

![Figure 11-5](<./images/figure 11-5.png>)

图 11-5. Wormhole 跨链架构

Chainlink 的跨链互操作协议（CCIP）建立在其现有的预言机网络之上，为区块链之间的安全消息传递和代币转移提供了一个通用框架。
其核心在于实现高度的信任最小化，依靠去中心化预言机来验证不同网络间的事件。CCIP 可以在源链上锁定或销毁代币，然后在目标链上铸造或解锁代币，
使 DApp 能够将其功能扩展到多个生态系统。通过复用 Chainlink 为去中心化数据喂价和可验证随机性所开发的成熟基础设施，CCIP 为那些已经依赖这些服务的项目提供了一条通向跨链运营的自然路径。

> [!Note]
> Circle 的跨链传输协议（CCTP）也值得一提。它的工作原理与 CCIP 类似，但主要用于在不同链之间桥接 USDC。目前，CCTP 已经被 Chainlink 集成到了 CCIP 之中。

除了这些协议外，越来越多的互操作层和桥接解决方案正在涌现，各自填补了略有不同的市场空白。
例如，Polkadot（波卡）和 Cosmos 等项目从底层构建时就具备了跨链能力，利用平行链（Parachains）和枢纽（Hubs）等设计来促进资产和数据的无缝交换。
Cosmos 中的跨链通信（IBC）协议使用客户端验证机制，每个连接的链都存储其他链的“轻客户端”。而 Polkadot 则通过中继链（Relay Chain）中的共享验证者集来保护平行链的安全，
将来自每个平行链的交易捆绑进统一的共识中。这些架构优先考虑可扩展性和安全性，但也引入了各自的学习曲线，特别是对于那些习惯于类以太坊环境的开发者而言。

## 结语

正如你所看到的，跨链协议和预言机通过将外部信息引入合约执行，为智能合约赋予了至关重要的功能。当然，随之而来的是，
预言机也引入了重大风险——如果它们是受信任的来源且遭到攻破，就会导致其供养的智能合约执行受损。当你考虑使用预言机时，
通常应对信任模型保持高度警惕。如果你预设预言机是完全可信的，那么你的智能合约在面对潜在的错误输入时可能会变得极其脆弱。
然而，如果安全假设经过深思熟虑，预言机将会非常有用。

去中心化预言机可以解决其中的部分疑虑，并为以太坊智能合约提供去信任化的外部数据。谨慎选择，你就可以开始探索预言机所提供的连接以太坊与“现实世界”的桥梁。

我们还研究了跨链协议如何充当以太坊与其他生态系统之间的桥梁，它们承载了预言机的大部分潜力和风险，但进一步扩展了应用场景和功能范围。


[^1]: 虽然本意是神谕，但是IT行业的大哥之一“Oracle”在中国的名称是“甲骨文”，很有意思的理解。
